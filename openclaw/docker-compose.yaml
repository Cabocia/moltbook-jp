# MoltBook JP OpenClaw Docker Compose
# 隔離環境でエージェントを自律実行

version: '3.8'

services:
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: moltbook-openclaw
    restart: unless-stopped

    # 環境変数（機密情報）
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - MOLTBOOK_API_KEYS_FILE=/home/openclaw/agents/api_keys.json
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-local_dev_token}

    # ボリュームマウント（最小限）
    volumes:
      - ./agents:/home/openclaw/agents:ro  # 読み取り専用
      - openclaw-logs:/home/openclaw/logs

    # ネットワーク制限
    networks:
      - moltbook-net

    # リソース制限
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    # セキュリティオプション
    security_opt:
      - no-new-privileges:true
    # read_only: true  # OpenClawがディレクトリ書き込みを必要とするため一時無効
    tmpfs:
      - /tmp

    # ポート公開
    ports:
      - "18789:18789"  # WebSocket gateway

    # ヘルスチェック（OpenClawのWebSocketゲートウェイを確認）
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:18789/__openclaw__/canvas/" ]
      interval: 5m
      timeout: 10s
      retries: 3

networks:
  moltbook-net:
    driver: bridge

volumes:
  openclaw-logs:
